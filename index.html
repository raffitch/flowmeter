<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Flow-Sensor Calibration</title>
<style>
  body   {font-family:sans-serif;max-width:520px;margin:2rem auto}
  h1     {font-size:1.4rem;margin-bottom:.6rem}
  .big   {font-size:2.2rem;font-weight:700;margin:.4rem 0}
  button {padding:.6rem 1.2rem;font-size:1rem;margin:.25rem}
  #result{margin-top:1rem;font-size:1.2rem;color:#0a7900}
  #status{margin:.8rem 0;font-size:.95rem;color:#555}
  canvas {width:100%;max-height:260px;margin-top:1rem;border:1px solid #ccc}
</style>

<!-- Chart.js v3 (no plugins) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
<h1>Flow-sensor calibration</h1>

<div id="status">Connecting‚Ä¶</div>

<div>Pulses counted</div>
<div id="pulse"  class="big">0</div>

<div>Elapsed time</div>
<div id="timer" class="big">0.0&nbsp;s</div>

<div>Volume (L) <input id="volume" type="number" min="0.1" step="0.1" value="1" style="width:4em"></div>
<div>Regulator setting <input id="regSetting" type="text" style="width:6em"></div>
<div>Supply pressure <input id="supplyPressure" type="text" style="width:6em"></div>

<button id="start"  disabled>Start</button>
<button id="stop"   disabled>Stop</button>
<button id="reset"  disabled>Reset pulses</button>
<button id="saveCsv" disabled>Save CSV</button>
<button id="savePng" disabled>Save PNG</button>

<canvas id="flowChart"></canvas>

<div id="result"></div>

<script>
(() => {
  /* --- Configurable filter strength (0.0‚Ää‚Äì‚Ää1.0) --- */
  const ALPHA = 0.5;     // 0.25 ‚âà keep 75 % of new value

  /* --- DOM refs --- */
  const $ = id => document.getElementById(id);
  const statusEl=$('status'), pulseEl=$('pulse'), timerEl=$('timer'),
        resultEl=$('result'), startBtn=$('start'), stopBtn=$('stop'),
        resetBtn=$('reset'),  saveCsvBtn=$('saveCsv'), savePngBtn=$('savePng'),
        volumeEl=$('volume'), regEl=$('regSetting'), pressureEl=$('supplyPressure'),
        chartCtx=$('flowChart');

  /* --- Chart.js (rolling WINDOW_SEC‚Äësecond window) --- */
  const WINDOW_SEC = 90;        // adjust to change graph width
  const flowChart  = new Chart(chartCtx,{
    type:'line',
    data:{datasets:[{
    label:'Flow rate (pps)',
    data:[],
    /* colour lines ‚Üì‚Üì‚Üì */
    borderColor:'#c00',                 // red stroke  (#c00 ‚âà rgb 204,0,0)
    backgroundColor:'rgba(255,0,0,.10)',// optional faint fill
    /* the rest */
    borderWidth:1,
    tension:.25,
    pointRadius:0
}]},
    options:{
      animation:false,
      scales:{
        x:{type:'linear',title:{display:true,text:'time (s)'},
           min:0,max:WINDOW_SEC},
        y:{beginAtZero:true,title:{display:true,text:'pulses / s'}}
      },
      plugins:{legend:{display:false}}
    }
  });

  /* --- run-time state --- */
  let armed=false,running=false;
  let t0=0;
  let lastPulse=0,lastTime=performance.now(),lastChange=performance.now();
  let filtPps = null;            // holds the filtered value
  let runStart=null, runEnd=null;
  const NO_FLOW_MS = 1000;

  /* --- helpers: downloads --- */
  function downloadCsv(){
    const rows=flowChart.data.datasets[0].data;
    if(!rows.length){alert('No data yet');return;}
    let csv='';
    if(runStart) csv += `# start=${runStart.toISOString()}\n`;
    if(runEnd)   csv += `# end=${runEnd.toISOString()}\n`;
    csv += `# volume_L=${volumeEl.value}\n`;
    csv += `# regulator_setting=${regEl.value}\n`;
    csv += `# supply_pressure=${pressureEl.value}\n`;
    csv+='time_s,pps_filtered\n';
    rows.forEach(p=>csv+=`${p.x},${p.y}\n`);
    const url=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
    Object.assign(document.createElement('a'),{href:url,download:'flow_curve.csv'}).click();
    URL.revokeObjectURL(url);
  }
  function downloadPng(){
    const url=flowChart.toBase64Image('image/png');
    Object.assign(document.createElement('a'),{href:url,download:'flow_chart.png'}).click();
  }
  function resetChart(){
    flowChart.data.datasets[0].data.length=0;
    flowChart.options.scales.x.min=0;
    flowChart.options.scales.x.max=WINDOW_SEC;
    flowChart.update('none');
    filtPps=null;
  }
  function softReset(){
    pulseEl.textContent='0';
    timerEl.textContent='0.0 s';
    resultEl.textContent='';
    resetChart();
    armed=running=false;
    lastPulse=0; lastTime=performance.now();
    runStart=null; runEnd=null;
  }

  /* --- WebSocket to Python bridge --- */
  const ws=new WebSocket('ws://localhost:8765');
  ws.onopen =()=>statusEl.textContent='üü¢ WebSocket open';
  ws.onerror=()=>statusEl.textContent='üî¥ WebSocket error';

  ws.onmessage=e=>{
    const d=JSON.parse(e.data);
    const now=performance.now();

    /* 1Ô∏è‚É£ live frame ----------------------------------------------------- */
    if(d.type==='live'){
      const pulses=d.pulses;
      pulseEl.textContent=pulses;

      /* arm->running transition on first pulse */
      if(armed && !running && pulses!==lastPulse){
        running=true; t0=now; lastChange=now; filtPps=null;
      }

      /* raw instantaneous pps */
      const dt=(now-lastTime)/1000;
      if(dt>0){
        const rawPps=(pulses-lastPulse)/dt;

        /* --- exponential smoothing ------------------------------------ */
        if(filtPps===null) filtPps=rawPps;          // initialise
        else filtPps = ALPHA*rawPps + (1-ALPHA)*filtPps;

        /* plot --------------------------------------------------------- */
        const t=running?((now-t0)/1000):0;
        const pts=flowChart.data.datasets[0].data;
        pts.push({x:t,y:filtPps});
        while(pts.length && t-pts[0].x>WINDOW_SEC) pts.shift();
        flowChart.options.scales.x.min=Math.max(0,t-WINDOW_SEC);
        flowChart.options.scales.x.max=Math.max(WINDOW_SEC,t);
        flowChart.update('none');
      }

      if(pulses!==lastPulse) lastChange=now;
      if(running) timerEl.textContent=`${((now-t0)/1000).toFixed(1)} s`;

      /* auto-stop after NO_FLOW_MS of zero-increment */
      if(running && now-lastChange>NO_FLOW_MS){
        ws.send('stop'); armed=running=false;
      }

      lastPulse=pulses; lastTime=now;
    }

    /* 2Ô∏è‚É£ status messages ---------------------------------------------- */
    if(d.type==='status'){
      if(d.msg==='serial-open'){
        statusEl.textContent='üü¢ Serial link ready';
        startBtn.disabled=resetBtn.disabled=false;
        saveCsvBtn.disabled=savePngBtn.disabled=false;
      }
      if(d.msg==='counter-reset'){softReset();resultEl.textContent='Counter reset ‚úîÔ∏é';}
    }

    /* 3Ô∏è‚É£ acknowledgements --------------------------------------------- */
    if(d.type==='ack'){
      if(d.status==='started'){
        armed=true; running=false;
        lastPulse=Number(pulseEl.textContent);
        lastTime=lastChange=performance.now();
        timerEl.textContent='0.0 s'; resultEl.textContent='';
        resetChart();
        runStart=new Date(); runEnd=null;
        startBtn.disabled=true; stopBtn.disabled=false;
      }
      if(d.status==='reset-sent'){resultEl.textContent='Reset request sent‚Ä¶';}
    }

    /* 4Ô∏è‚É£ calibration result ------------------------------------------- */
    if(d.type==='cal'){
      armed=running=false;
      startBtn.disabled=false; stopBtn.disabled=true;
      runEnd=new Date();
      timerEl.textContent=`${d.elapsed.toFixed(1)} s`;
      resultEl.innerHTML=`<strong>${d.ppl}</strong> pulses / L (vol=${d.volume}L)<br>
                          (Œî=${d.delta} pulses in ${d.elapsed}s)`;
    }
  };

  /* --- button handlers --- */
  startBtn.onclick =()=>{
    ws.send(JSON.stringify({cmd:'start',volume:Number(volumeEl.value)}));
  };
  stopBtn.onclick  =()=>{ws.send('stop');armed=running=false;};
  resetBtn.onclick =()=>ws.send('reset');
  saveCsvBtn.onclick=downloadCsv;
  savePngBtn.onclick=downloadPng;
})();
</script>

</body>
</html>
